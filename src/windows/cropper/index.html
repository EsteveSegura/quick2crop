<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Quick2Crop</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.6/cropper.min.css">
  <link href="https://fonts.googleapis.com/css?family=Hepta+Slab&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./css/main.css">
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
</head>

<body>
  <div id="title-bar">
    <div id="title">Quick2Crop</div>
    <div id="title-bar-btns">
      <div id="close"> <img src="./svg/1727490.svg" width="10" alt=""> </div>
    </div>
  </div>
  <div id="ui" class="container">
    <div class="img-container" style="visibility: hidden; position: absolute ;">
      <img id="image"
        src="https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjExMzk2fQ&w=1000&q=80"
        alt="Picture">
    </div>
    
    <div>
      <button onclick="cropNextImage()">Next</button>
      <button onclick="saveProcess()">Save process</button>
    </div>
    <div id="croper" class="img-container croper">
      <canvas id="canvas"></canvas>
    </div>
  </div>

  <div id="warn">
    Load folder... File -> Open Folder (Ctrl or CMD + O)
  </div>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.6/cropper.js"></script>

  <script>
    
    const { ipcRenderer } = require('electron');

    let dataFilesCropped = [];
    let filesToCrop = [];
    let actualCrop = {};
    let filesDir = "";
    let count = 0;
    let cropper;


    window.addEventListener('DOMContentLoaded', function () {
      let canvas = document.getElementById('canvas');
      let image = document.getElementById('image');
      hideUI()
    });

    ipcRenderer.on('getFiles', (event, files) => {
      hideWarn();
      flushData();
      showUI();
      let image = document.getElementById('image');
      filesToCrop = files.files;
      filesDir = files.dir;
      image.src = `${filesDir}/${filesToCrop[0]}`
      if (count == 0) {
        count = 0;
        if (image.complete) {
          start.call(image);
        } else {
          image.onload = start;
        }
      }
    });

    function cropNextImage() {
      if (count == 0) {
        filesToCrop.shift()
        cropper.replace(`${filesDir}/${filesToCrop[0]}`)
      } else if (count == 1) {
        filesToCrop.shift()
        cropper.replace(`${filesDir}/${filesToCrop[0]}`)
      } else {
        filesToCrop.shift()
        cropper.replace(`${filesDir}/${filesToCrop[0]}`)
      }

      dataFilesCropped.push(actualCrop);
      setTimeout(() => { cropper.clear(); }, 50);
      count++;
      if (filesToCrop.length == 0) {
        hideCanvas()
        sendPictureToCut()
        hideUI()
        cropper.destroy()
      }
    }

    function saveProcess(){
      hideCanvas()
      sendPictureToCut()
      hideUI()
      cropper.destroy()
    }

    function hideCanvas() {
      document.getElementById('croper').style.display = "none";
    }

    function showCanvas() {
      document.getElementById('croper').style.display = "block";
    }

    function sendPictureToCut() {
      ipcRenderer.send('filesToCrop', dataFilesCropped)
    }

    function hideUI() {
      document.getElementById('ui').style.display = "none";
    }

    function showUI() {
      document.getElementById('ui').style.display = "block";
    }

    function hideWarn() {
      document.getElementById('warn').style.display = "none";
    }

    function flushData() {
      dataFilesCropped = [];
      filesToCrop = [];
      actualCrop = {};
      filesDir = "";
    }

    function start() {
      showCanvas()
      let width = this.offsetWidth;
      let height = this.offsetHeight;

      canvas.width = width;
      canvas.height = height;
      canvas.getContext('2d').drawImage(
        this,
        0, 0, this.naturalWidth, this.naturalHeight,
        0, 0, width, height
      );

      cropper = new Cropper(canvas, {
        background: false,
        crop(event) {
          actualCrop = {
            fileName: `${filesDir}/${filesToCrop[0]}`,
            x: event.detail.x,
            y: event.detail.y,
            width: event.detail.width,
            height: event.detail.height
          }
          console.log(actualCrop)
        }
      });

      setTimeout(() => { cropper.clear(); }, 50);
    }


    document.body.onkeyup = function (e) {
      if (e.keyCode == 32) {
        cropNextImage()
      }
    }

    document.getElementById('close').addEventListener('click', function () {
      window.close();
    });

  </script>
</body>

</html>